<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alaska Guesser</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        /* Custom Styles & Animations */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        #pano {
            height: 100vh;
            background: #333;
        }
        #map-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #map {
            flex-grow: 1;
            min-height: 0;
        }
        @keyframes score-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); color: #198754; }
            100% { transform: scale(1); }
        }
        .score-popped {
            animation: score-pop 0.5s ease-out;
        }
        /* Fade-in for results and facts */
        .fade-in-container {
            transition: opacity 0.7s ease-in-out;
        }
    </style>
</head>
<body>

    <div class="container-fluid g-0">
        <div class="row g-0">
            <div class="col-lg-7">
                <div id="pano"></div>
            </div>
            <div class="col-lg-5">
                <div id="map-container">
                    <div id="map"></div>
                    <div id="ui" class="text-center p-3 bg-light border-top">
                        <div class="d-flex justify-content-around align-items-center mb-3">
                            <h5 id="score-display" class="mb-0">Round: 1/5 | Score: 0</h5>
                            <h5 id="timer-display" class="mb-0 text-danger"></h5>
                        </div>

                        <div id="info-container" class="fade-in-container opacity-0">
                            <div id="resultText" class="alert alert-info" role="alert"></div>
                            <div id="fact-container" class="alert alert-light" style="display: none;">
                                <strong class="d-block mb-1">Did you know?</strong>
                                <span id="factText"></span>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                             <button id="actionBtn" class="btn btn-primary btn-lg">Make Guess</button>
                        </div>

                        <div id="scoreboard" class="card mt-3" style="display: none;">
                            <div class="card-body">
                                <h5 class="card-title">Final Score</h5>
                                <p class="card-text fs-3" id="final-score-text"></p>
                                <button class="btn btn-success" id="submitScoreBtn">Submit Score</button>
                                <button class="btn btn-secondary" id="playAgainBtn" style="display:none;">Play Again?</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="gameSetupModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="staticBackdropLabel"><i class="bi bi-geo-alt-fill"></i> Alaska Guesser</h1>
          </div>
          <div class="modal-body">
            <div id="apiKeySection">
                <label for="apiKeyInput" class="form-label">Enter Your Google Maps API Key</label>
                <input type="text" class="form-control mb-2" id="apiKeyInput" placeholder="Paste your API key here">
                <div class="d-grid">
                    <button id="submitApiKeyBtn" class="btn btn-primary">Continue</button>
                </div>
                 <hr>
                <a class="btn btn-link p-0" data-bs-toggle="collapse" href="#collapseInstructions" role="button" aria-expanded="false" aria-controls="collapseInstructions">
                    How do I get a key?
                </a>
                <div class="collapse" id="collapseInstructions">
                    <div class="card card-body mt-2">
                        <ol class="list-group list-group-numbered list-group-flush">
                            <li class="list-group-item">Go to the <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a>.</li>
                            <li class="list-group-item">Enable both <strong>"Maps JavaScript API"</strong> and <strong>"Geocoding API"</strong>.</li>
                            <li class="list-group-item">Go to <strong>APIs & Services > Credentials</strong> to create and copy your key.</li>
                        </ol>
                    </div>
                </div>
            </div>
            <div id="gameModeSection" style="display: none;">
                <h5>Select a Game Mode</h5>
                <div class="d-grid gap-2 mt-3">
                    <button class="btn btn-outline-primary" onclick="startGame('classic')">Classic Mode</button>
                    <button class="btn btn-outline-primary" onclick="startGame('timeAttack')">Time Attack</button>
                    <button class="btn btn-outline-primary" onclick="startGame('beatTheClock')">Beat the Clock</button>
                    <button class="btn btn-outline-primary" onclick="startGame('landmarks')">Landmark Guesser</button>
                </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

    <script>
        // Game state variables
        let panorama, map, streetViewService;
        let currentGuess, actualLocation, preloadedLocation;
        let guessMarker = null, answerMarker = null, resultLine = null;
        let currentRound = 1, totalScore = 0;
        const MAX_ROUNDS = 5;
        let gameMode = 'classic', timerInterval, timeLeft = 0, userApiKey = '', gameSetupModal;

        // Coordinates for different regions in Alaska
        const alaskaRegions = [
            { sw: { lat: 60.0, lng: -152.5 }, ne: { lat: 65.0, lng: -144.0 } }, // Southcentral & Interior
            { sw: { lat: 59.4, lng: -152.0 }, ne: { lat: 61.0, lng: -149.0 } }, // Kenai Peninsula
            { sw: { lat: 57.0, lng: -135.8 }, ne: { lat: 58.5, lng: -134.0 } }, // Southeast
            { sw: { lat: 65.0, lng: -151.0 }, ne: { lat: 70.0, lng: -148.0 } }  // Dalton Highway
        ];

        // Landmark locations
        const landmarks = [
            { lat: 63.7305, lng: -148.9130, name: "Denali National Park" },
            { lat: 58.3019, lng: -134.4197, name: "Mendenhall Glacier" },
            { lat: 60.5268, lng: -151.2483, name: "Kenai Fjords National Park" },
            { lat: 64.8378, lng: -147.7164, name: "Fairbanks" },
            { lat: 57.1764, lng: -135.3239, name: "Sitka" }
        ];

        function startGame(mode) {
            gameMode = mode;
            gameSetupModal.hide();
            loadGoogleMapsScript(userApiKey);
        }

        function loadGoogleMapsScript(apiKey) {
            if (document.getElementById('googleMapsScript')) {
                initGame();
                return;
            }
            const script = document.createElement('script');
            script.id = 'googleMapsScript';
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initGame&libraries=geometry`;
            script.defer = true;
            script.onerror = () => {
                alert("Invalid API Key or API not enabled correctly. Please check and try again.");
                gameSetupModal.show();
            };
            document.head.appendChild(script);
        }

        function startNewRound() {
            if (currentRound > MAX_ROUNDS && gameMode !== 'timeAttack') {
                endGame();
                return;
            }
            document.getElementById('info-container').classList.add('opacity-0');
            document.getElementById('fact-container').style.display = 'none';
            if (guessMarker) guessMarker.setMap(null);
            if (answerMarker) answerMarker.setMap(null);
            if (resultLine) resultLine.setMap(null);
            currentGuess = null; 
            guessMarker = null;
            
            const actionBtn = document.getElementById('actionBtn');
            actionBtn.innerText = "Make Guess";
            actionBtn.disabled = false;
            actionBtn.onclick = makeGuess;

            updateScoreDisplay();
            
            if (gameMode === 'beatTheClock') {
                timeLeft = 30; 
                startTimer();
            } else if (gameMode === 'timeAttack' && currentRound === 1) {
                timeLeft = 180; 
                startTimer();
            }

            if (gameMode === 'landmarks') {
                const landmark = landmarks[currentRound - 1];
                actualLocation = new google.maps.LatLng(landmark.lat, landmark.lng);
                panorama.setPosition(actualLocation);
                panorama.setVisible(true);
            } else {
                actualLocation = preloadedLocation;
                panorama.setPosition(actualLocation);
                panorama.setVisible(true);
                findRandomLocation(true); 
            }
        }

        function findRandomLocation(isPreload = false) {
            const region = alaskaRegions[Math.floor(Math.random() * alaskaRegions.length)];
            const randomLat = Math.random() * (region.ne.lat - region.sw.lat) + region.sw.lat;
            const randomLng = Math.random() * (region.ne.lng - region.sw.lng) + region.sw.lng;
            const randomPoint = { lat: randomLat, lng: randomLng };

            streetViewService.getPanorama({ 
                location: randomPoint, 
                radius: 50000,
                source: 'outdoor'
            }, (data, status) => {
                if (status === 'OK') {
                    if (isPreload) {
                        preloadedLocation = data.location.latLng;
                    } else {
                        actualLocation = data.location.latLng;
                        panorama.setPosition(actualLocation);
                        panorama.setVisible(true);
                        findRandomLocation(true);
                    }
                } else {
                    findRandomLocation(isPreload); 
                }
            });
        }
        
        async function makeGuess() {
            if (!currentGuess) {
                alert("Please place a marker on the map first!");
                return;
            }
            
            if (gameMode === 'beatTheClock') {
                clearInterval(timerInterval);
                totalScore += timeLeft;
            }

            const distance = google.maps.geometry.spherical.computeDistanceBetween(currentGuess, actualLocation);
            const score = calculateScore(distance);
            totalScore += score;
            
            const distanceInKm = (distance / 1000).toFixed(2);
            document.getElementById('resultText').innerText = `You were ${distanceInKm} km away! You scored ${score} points.`;
            document.getElementById('info-container').classList.remove('opacity-0');
            updateScoreDisplay(true);
            
            answerMarker = new google.maps.Marker({ position: actualLocation, map: map });
            resultLine = new google.maps.Polyline({ path: [currentGuess, actualLocation], map: map });
            map.fitBounds(new google.maps.LatLngBounds(currentGuess, actualLocation));

            currentRound++;
            const actionBtn = document.getElementById('actionBtn');
            actionBtn.innerText = currentRound > MAX_ROUNDS ? "View Final Score" : "Play Next Round";
            actionBtn.onclick = startNewRound;
            
            // *** NEW: Fetch the location fact after guess ***
            await fetchLocationFact(actualLocation.lat(), actualLocation.lng());
        }

        // *** NEW: Function to get fact from coordinates ***
        async function fetchLocationFact(lat, lng) {
            try {
                // Step 1: Reverse Geocode to get a place name
                const geocodeUrl = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${userApiKey}`;
                const geocodeResponse = await fetch(geocodeUrl);
                const geocodeData = await geocodeResponse.json();
                if (!geocodeData.results || geocodeData.results.length === 0) {
                    throw new Error("No location found.");
                }
                
                // Find a useful name from the results (e.g., a park, city, or region)
                const locationName = parseLocationName(geocodeData.results);
                if (!locationName) return;

                // Step 2: Use the place name to query Wikipedia
                const wikipediaUrl = `https://en.wikipedia.org/w/api.php?action=query&format=json&prop=extracts&exintro=true&explaintext=true&redirects=1&origin=*&titles=${encodeURIComponent(locationName)}`;
                const wikipediaResponse = await fetch(wikipediaUrl);
                const wikipediaData = await wikipediaResponse.json();
                
                const pages = wikipediaData.query.pages;
                const pageId = Object.keys(pages)[0];
                const extract = pages[pageId].extract;

                // Step 3: Display the fact
                if (extract) {
                    document.getElementById('factText').innerText = extract;
                    document.getElementById('fact-container').style.display = 'block';
                }
            } catch (error) {
                console.error("Error fetching location fact:", error);
                // Don't display the fact box if there's an error
            }
        }
        
        // *** NEW: Helper function to find the best name from geocode results ***
        function parseLocationName(results) {
            for (const result of results) {
                // Prioritize natural features or points of interest
                if (result.types.includes('natural_feature') || result.types.includes('point_of_interest') || result.types.includes('park')) {
                    return result.address_components[0].long_name;
                }
            }
            // Fallback to the first formatted address if no specific feature is found
            return results[0]?.formatted_address.split(',')[0] || null;
        }

        function calculateScore(distance) {
            const maxDistance = 2000000; 
            if (distance > maxDistance) return 0;
            return Math.round(5000 * Math.exp(-5 * (distance / maxDistance)));
        }
        
        function updateScoreDisplay(withAnimation = false) {
            const scoreEl = document.getElementById('score-display');
            scoreEl.innerText = `Round: ${Math.min(currentRound, MAX_ROUNDS)}/${MAX_ROUNDS} | Score: ${totalScore}`;
            if (withAnimation) {
                scoreEl.classList.add('score-popped');
                scoreEl.addEventListener('animationend', () => scoreEl.classList.remove('score-popped'), { once: true });
            }
        }

        function endGame() {
            clearInterval(timerInterval);
            document.getElementById('timer-display').innerText = '';
            document.getElementById('final-score-text').innerText = totalScore;
            document.getElementById('scoreboard').style.display = 'block';
            document.getElementById('actionBtn').style.display = 'none';
        }
        
        function startTimer() {
            const timerDisplay = document.getElementById('timer-display');
            timerInterval = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerDisplay.innerText = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    if (gameMode === 'timeAttack') endGame();
                    else {
                        document.getElementById('resultText').innerText = "Time's up! No points for this round.";
                        document.getElementById('info-container').classList.remove('opacity-0');
                        currentRound++;
                        const actionBtn = document.getElementById('actionBtn');
                        actionBtn.innerText = currentRound > MAX_ROUNDS ? "View Final Score" : "Play Next Round";
                        actionBtn.onclick = startNewRound;
                    }
                }
            }, 1000);
        }
        
        function initGame() {
            streetViewService = new google.maps.StreetViewService();
            map = new google.maps.Map(document.getElementById('map'), { center: { lat: 64, lng: -152 }, zoom: 4 });
            panorama = new google.maps.StreetViewPanorama(document.getElementById('pano'), {
                visible: false, addressControl: false, linksControl: false, showRoadLabels: false, fullscreenControl: false
            });
            
            map.addListener('click', (e) => {
                currentGuess = e.latLng;
                if (guessMarker) guessMarker.setPosition(currentGuess);
                else {
                    guessMarker = new google.maps.Marker({ position: currentGuess, map: map, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, strokeColor: '#fff', strokeWeight: 2, fillColor: '#0d6efd', fillOpacity: 1 }});
                }
            });
            
            if (gameMode !== 'landmarks') {
                findRandomLocation(false);
            }
            startNewRound();
        }

        document.addEventListener('DOMContentLoaded', () => {
            gameSetupModal = new bootstrap.Modal(document.getElementById('gameSetupModal'));
            gameSetupModal.show();
            
            document.getElementById('submitApiKeyBtn').addEventListener('click', () => {
                userApiKey = document.getElementById('apiKeyInput').value.trim();
                if (userApiKey) {
                    document.getElementById('apiKeySection').style.display = 'none';
                    document.getElementById('gameModeSection').style.display = 'block';
                } else {
                    alert("Please enter an API key.");
                }
            });

            document.getElementById('submitScoreBtn').addEventListener('click', () => {
                const playerName = prompt("Enter your name for the scoreboard:", "Player");
                if (playerName) {
                    alert(`Score submitted for ${playerName}! (This is a placeholder)`);
                    document.getElementById('submitScoreBtn').style.display = 'none';
                    document.getElementById('playAgainBtn').style.display = 'inline-block';
                }
            });
            
            document.getElementById('playAgainBtn').addEventListener('click', () => window.location.reload());
        });
    </script>
</body>
</html>